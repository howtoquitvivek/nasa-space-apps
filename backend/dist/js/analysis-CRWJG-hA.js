import"./modulepreload-polyfill-B5Qt9EMX.js";import{_ as He}from"./preload-helper-D7HrI6pR.js";document.addEventListener("DOMContentLoaded",()=>{const p="http://localhost:8000";let r,l,V,m,u,L,z=!1,E=[],w=null,f=[],B=1,$=!0,b=!0;const K=document.getElementById("zoom-info"),de=document.getElementById("dataset-name");document.getElementById("loading-overlay"),document.getElementById("status-message"),document.getElementById("progress-fill"),document.getElementById("progress-text");const x=document.getElementById("ai-panel-toggle"),S=document.getElementById("ai-panel-content"),C=document.getElementById("activate-similarity-btn"),F=document.getElementById("simulate-clustering-btn"),me=document.getElementById("clustering-algorithm"),T=document.getElementById("cluster-count"),ue=document.getElementById("cluster-count-display"),g=document.getElementById("analysis-feed-content"),P=document.getElementById("clear-feed-btn"),fe=document.getElementById("find-similar-btn"),M=document.getElementById("search-deeper-btn"),O=document.getElementById("toggle-annotations-btn"),N=document.getElementById("toggle-labels-btn"),U=document.getElementById("clear-highlights-btn"),J=document.getElementById("annotations-on-icon"),Q=document.getElementById("annotations-off-icon"),I=document.getElementById("clustering-overlay"),R=document.getElementById("close-clustering-btn"),D=document.getElementById("legend-items"),X=document.getElementById("silhouette-score"),W=document.getElementById("inertia-score"),k=document.getElementById("ai-results-panel"),j=document.getElementById("results-content"),Z=document.getElementById("close-results-btn"),G=document.getElementById("export-results-btn"),ee=new URLSearchParams(window.location.search),y=ee.get("dataset"),h=ee.get("footprint");if(!y||!h){document.getElementById("map-container").innerHTML='<p style="padding: 2rem; text-align: center; color: var(--color-error);">Invalid URL. Please return to Mission Control.</p>';return}ge();function ge(){pe(),ye(),he(),Ae(),te(),_e()}function pe(){const e=document.getElementById("particles");if(e)for(let t=0;t<40;t++){const n=document.createElement("div");n.className="particle",n.style.left=Math.random()*100+"%",n.style.top=Math.random()*100+"%",n.style.animationDelay=Math.random()*12+"s",n.style.animationDuration=8+Math.random()*4+"s",e.appendChild(n)}}function ye(){He(()=>import("./leaflet.draw-cJkf-kdY.js"),[]).then(()=>{l=window.L,Be();const n=l.icon({iconUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png",shadowUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41]});l.Marker.prototype.options.icon=n,r=l.map("map-container",{center:[0,0],zoom:0,zoomControl:!1}),m=new l.FeatureGroup().addTo(r),u=new l.FeatureGroup().addTo(r),L=new l.FeatureGroup().addTo(r);const o=new l.Control.Draw({edit:{featureGroup:m,edit:!1,remove:!0},draw:{polygon:!0,polyline:!0,rectangle:{showArea:!1},circle:!1,circlemarker:!1,marker:!0}});r.addControl(o),r.on(l.Draw.Event.CREATED,ze),r.on("draw:deleted",Fe),m.on("click",xe),r.on("zoomend",ae),Te(y,h),$e()})}function he(){var e,t;x==null||x.addEventListener("click",Ee),C==null||C.addEventListener("click",H),F==null||F.addEventListener("click",Le),T==null||T.addEventListener("input",Ie),P==null||P.addEventListener("click",ve),O==null||O.addEventListener("click",Ne),N==null||N.addEventListener("click",Ue),U==null||U.addEventListener("click",Re),R==null||R.addEventListener("click",Ce),Z==null||Z.addEventListener("click",oe),G==null||G.addEventListener("click",ke),(e=document.getElementById("activate-similarity-btn"))==null||e.addEventListener("click",le),(t=document.getElementById("search-deeper-btn"))==null||t.addEventListener("click",Oe)}function Ae(){s("AI system initialization complete","success"),s("Neural networks loaded and ready","success"),s("Feature extraction pipeline active","success"),setInterval(()=>{te()},5e3)}function te(){const e=80+Math.random()*15,t=20+Math.random()*10,n=2.4+Math.random()*.2;document.getElementById("gpu-status").textContent=`${Math.floor(e)}% Active`,document.getElementById("memory-status").textContent=`${t.toFixed(1)} GB`,document.getElementById("index-status").textContent=`${n.toFixed(1)}M vectors`;const o=94.5+Math.random()*.4,a=.25+Math.random()*.1;document.getElementById("similarity-accuracy").textContent=`${o.toFixed(1)}%`,document.getElementById("search-speed").textContent=`${a.toFixed(2)}s`}function s(e,t="success",n=null){if(!g)return;const a=(n||new Date).toLocaleTimeString("en-US",{hour12:!1,hour:"2-digit",minute:"2-digit",second:"2-digit"}),i=document.createElement("div");for(i.className="feed-item",i.innerHTML=`
            <div class="feed-timestamp">${a}</div>
            <div class="feed-message">${e}</div>
            <div class="feed-status ${t}"></div>
        `,g.insertBefore(i,g.firstChild);g.children.length>20;)g.removeChild(g.lastChild);g.scrollTop=0}function ve(){g&&(g.innerHTML="",s("Analysis feed cleared","success"))}function Ee(){if(!S)return;const e=S.style.display==="none",t=x.querySelector("i");e?(S.style.display="block",t.className="fas fa-chevron-up"):(S.style.display="none",t.className="fas fa-chevron-down")}function H(){z=!0,s("Similarity search mode activated","success"),s("Click on any annotation to find similar features","success"),C.style.transform="scale(0.95)",setTimeout(()=>{C.style.transform="scale(1)"},150)}function Ie(){const e=T.value;ue.textContent=e}function Le(){const e=me.value,t=parseInt(T.value);s(`Initializing ${e.toUpperCase()} clustering`,"success"),s(`Target clusters: ${t}`,"success"),_("Performing AI clustering analysis..."),setTimeout(()=>v(),4e3),A(0);let n=0;const o=setInterval(()=>{n+=Math.random()*15,n>=100&&(n=100,clearInterval(o),setTimeout(()=>{v(),we(e,t)},500)),A(n)},200)}function we(e,t){L.clearLayers();const n=["#ff6b6b","#4ecdc4","#45b7d1","#96ceb4","#feca57","#ff9ff3","#54a0ff","#5f27cd","#10ac84","#ee5a24"],o=[];for(let c=0;c<t;c++)o.push({id:c,color:n[c%n.length],label:`Cluster ${c+1}`,points:[]});const a=r.getBounds(),i=50+Math.random()*100;for(let c=0;c<i;c++){const d=a.getSouth()+(a.getNorth()-a.getSouth())*Math.random(),Ge=a.getWest()+(a.getEast()-a.getWest())*Math.random(),Y=Math.floor(Math.random()*t),q=l.circleMarker([d,Ge],{radius:6,color:"white",fillColor:o[Y].color,fillOpacity:.8,weight:2});q.bindTooltip(`${o[Y].label}<br/>Confidence: ${(.7+Math.random()*.3).toFixed(3)}`),L.addLayer(q),o[Y].points.push(q)}be(o),s(`${e.toUpperCase()} clustering completed`,"success"),s(`${o.length} clusters identified`,"success"),s(`${Math.floor(i)} features analyzed`,"success")}function be(e,t){D&&(D.innerHTML="",e.forEach(a=>{const i=document.createElement("div");i.className="legend-item",i.innerHTML=`
                    <div class="legend-color" style="background-color: ${a.color}"></div>
                    <div class="legend-label">${a.label}</div>
                `,D.appendChild(i)}));const n=.7+Math.random()*.2,o=1e3+Math.random()*500;X&&(X.textContent=n.toFixed(3)),W&&(W.textContent=o.toFixed(1)),I&&I.classList.add("active")}function Ce(){I&&I.classList.remove("active"),L.clearLayers(),s("Clustering analysis closed","success")}async function Te(e,t){_(`Loading dataset: ${e}/${t}...`);try{const n=await fetch(`${p}/datasets/${e}/${t}/bounds`);if(!n.ok)throw new Error(`Failed to load dataset bounds. Status: ${n.status}`);const o=await n.json(),{bounds:a}=o;if(Array.isArray(o.available_zooms)&&o.available_zooms.length>0){f=o.available_zooms;const c=Math.min(...f),d=Math.max(...f);B=c,r.options.minZoom=c,r.options.maxZoom=d}else console.warn("Warning: available_zooms is missing or invalid. Using default zoom levels."),f=[0,1,2,3,4,5,6,7,8,9,10],B=0,r.options.minZoom=0,r.options.maxZoom=10;V=l.tileLayer(`${p}/tiles/${e}/${t}/{z}/{x}/{y}.png`,{attribution:`&copy; ${e}/${t}`,noWrap:!0,bounds:l.latLngBounds(a),errorTileUrl:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=",detectRetina:!1}).addTo(r);const i=l.latLngBounds(a);r.setMaxBounds(i.pad(5)),r.setView(i.getCenter(),B),V.on("tileerror",function(c){console.debug("Tile loading error:",c)}),ae(),de.textContent=`${e}/${t}`}catch(n){console.error("Error loading dataset:",n),s(`Failed to load dataset: ${n.message}`,"error")}finally{setTimeout(v,300)}}function Be(){const e=l.GridLayer.prototype._addTile;l.GridLayer.prototype._addTile=function(n,o){return n.x<0||n.y<0||f.length>0&&!f.includes(n.z)?null:e.call(this,n,o)};const t=l.TileLayer.prototype._getTileUrl;l.TileLayer.prototype._getTileUrl=function(n){return n.x<0||n.y<0||f.length>0&&!f.includes(n.z)?"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=":t.call(this,n)}}async function $e(){try{const e=new URLSearchParams({dataset:y,footprint:h}),n=await(await fetch(`${p}/annotations?${e.toString()}`)).json();m.clearLayers(),n.forEach(o=>{const a=l.geoJSON(o.geojson).getLayers()[0];o.label&&(a._label=o.label,a.bindTooltip(o.label,{permanent:!0,direction:"top"}).openTooltip()),a._annotationId=o.id,a._dataset=o.dataset,a._footprint=o.footprint,m.addLayer(a)}),s(`${n.length} annotations loaded`,"success")}catch(e){console.error("Failed to load annotations:",e),s("Failed to load annotations","error")}}async function xe(e){const t=e.layer||e.target;t._annotationId&&(z?await Se(t):Pe(t))}async function Se(e){z=!1,_("AI analyzing surface features..."),A(0),E=[],w=e,M.disabled=!0;const t=r.getZoom();try{s("Initiating similarity search","success"),s("Extracting feature vectors","success"),A(20);const n=`${p}/annotations/similar?top_k=10&zoom=${t}`,o=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({annotation_id:e._annotationId,dataset:y,footprint:h,geojson:e.toGeoJSON()})});if(A(60),!o.ok){const i=await o.json();throw new Error(i.detail||`HTTP ${o.status}`)}A(80);const a=await o.json();ne(a,!0),E.push(t),A(100),u.getLayers().length>0&&(r.fitBounds(u.getBounds().pad(.1)),M.disabled=!1,Me(a)),s(`Found ${a.similar_tiles.length} similar features`,"success"),s("Search completed successfully","success")}catch(n){console.error("Similarity search error:",n),s(`Search failed: ${n.message}`,"error")}finally{v()}}function ne(e,t=!1){t&&u.clearLayers(),e.similar_tiles.forEach(n=>{const o=[[ie(n.y+1,n.z),se(n.x,n.z)],[ie(n.y,n.z),se(n.x+1,n.z)]],a=l.rectangle(o,{color:"#80ef80",weight:2,fillOpacity:.3}),i=`Score: ${n.score.toFixed(3)} Zoom: ${n.z}`;a.bindTooltip(i,{permanent:!0,direction:"top"}).openTooltip(),u.addLayer(a)})}function Me(e){!k||!j||(j.innerHTML="",e.similar_tiles.forEach((t,n)=>{const o=document.createElement("div");o.className="result-item",o.style.cssText=`
                padding: var(--space-3);
                margin-bottom: var(--space-2);
                background: rgba(15, 23, 42, 0.6);
                border-radius: var(--radius-sm);
                border-left: 3px solid hsl(${t.score*120}, 70%, 50%);
            `,o.innerHTML=`
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-weight: 600; color: var(--color-light);">Match ${n+1}</div>
                        <div style="font-size: 0.8rem; color: var(--color-gray-light);">
                            Similarity: ${(t.score*100).toFixed(1)}% | Zoom: ${t.z}
                        </div>
                    </div>
                    <div style="color: hsl(${t.score*120}, 70%, 60%); font-weight: 800; font-size: 1.2rem;">
                        ${(t.score*100).toFixed(0)}%
                    </div>
                </div>
            `,j.appendChild(o)}),k.classList.add("active"))}function oe(){k&&k.classList.remove("active")}function ke(){s("Exporting analysis results","success"),setTimeout(()=>{s("Results exported successfully","success")},1e3)}function _(e){const t=document.getElementById("loading-overlay"),n=document.getElementById("status-message");n&&(n.textContent=e),t&&(t.classList.remove("hidden"),t.style.display="flex"),A(0)}function v(){const e=document.getElementById("loading-overlay");e&&(e.classList.add("hidden"),e.style.display="none");const t=document.getElementById("map-loading");t&&(t.classList.add("hidden"),t.style.display="none")}function A(e){const t=document.getElementById("progress-fill"),n=document.getElementById("progress-text");t&&(t.style.width=`${e}%`),n&&(n.textContent=`${Math.round(e)}%`)}function ae(){if(!r||!K)return;const e=r.getZoom()-B;K.textContent=`Zoom Level: ${e}`}function se(e,t){return e/Math.pow(2,t)*360-180}function ie(e,t){const n=Math.PI-2*Math.PI*e/Math.pow(2,t);return 180/Math.PI*Math.atan(.5*(Math.exp(n)-Math.exp(-n)))}function _e(){const e=document.querySelector(".analysis-feed-panel"),t=document.getElementById("feed-collapse-btn"),n=document.getElementById("feed-info-btn");if(!e||!t)return;t.addEventListener("click",function(a){a.stopPropagation(),e.classList.toggle("collapsed");const i=t.querySelector("i");e.classList.contains("collapsed")?i.className="fas fa-chevron-up":i.className="fas fa-chevron-down"}),document.querySelector(".analysis-feed-panel .feed-header").addEventListener("click",function(a){if(e.classList.contains("collapsed")&&!a.target.closest("button")){e.classList.remove("collapsed");const i=t.querySelector("i");i.className="fas fa-chevron-down"}}),n&&n.addEventListener("click",function(a){a.stopPropagation(),alert("Analysis Feed shows real-time updates and notifications from the AI system. Click the arrow to collapse/expand.")})}async function ze(e){const t=e.layer,n=prompt("Enter label for this annotation:");n&&(t._label=n,t.bindTooltip(n,{permanent:!0,direction:"center"}).openTooltip()),m.addLayer(t);const o={id:String(Date.now()),dataset:y,footprint:h,geojson:t.toGeoJSON(),label:n};try{await fetch(`${p}/annotations`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)}),t._annotationId=o.id,s("New annotation created","success")}catch(a){console.error("Failed to save annotation:",a),s("Failed to save annotation","error")}}async function Fe(e){e.layers.eachLayer(async t=>{if(t._annotationId){const n=new URLSearchParams({dataset:y,footprint:h});await fetch(`${p}/annotations/${t._annotationId}?${n.toString()}`,{method:"DELETE"}),s("Annotation deleted","success")}})}async function Pe(e){const t=prompt("Edit label:",e._label||"");if(t!==null){e._label=t,e.getTooltip().setContent(t);const n=new URLSearchParams({dataset:y,footprint:h});await fetch(`${p}/annotations/${e._annotationId}?${n.toString()}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({label:t})}),s("Annotation label updated","success")}}async function Oe(){if(w){_("Searching additional zoom levels..."),M.disabled=!0;try{const e=`${p}/annotations/similar/more?top_k=10`,t=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({annotation_id:w._annotationId,dataset:y,footprint:h,geojson:w.toGeoJSON(),exclude_zooms:E})});if(!t.ok){const o=await t.json();throw new Error(o.detail||`HTTP ${t.status}`)}const n=await t.json();ne(n,!1),E.push(...f.filter(o=>!E.includes(o))),u.getLayers().length>0&&r.fitBounds(u.getBounds().pad(.1)),s(`Deep search found ${n.similar_tiles.length} additional matches`,"success")}catch(e){console.error("Deeper search error:",e),s(`Deep search failed: ${e.message}`,"error")}finally{v()}}}function Ne(){$=!$,$?(r.addLayer(m),J.classList.remove("hidden"),Q.classList.add("hidden")):(r.removeLayer(m),J.classList.add("hidden"),Q.classList.remove("hidden")),s(`Annotations ${$?"shown":"hidden"}`,"success")}function Ue(){b=!b,m.eachLayer(e=>{e.getTooltip()&&(b?e.openTooltip():e.closeTooltip())}),u.eachLayer(e=>{e.getTooltip()&&(b?e.openTooltip():e.closeTooltip())}),s(`Labels ${b?"shown":"hidden"}`,"success")}function Re(){u.clearLayers(),L.clearLayers(),E=[],w=null,M.disabled=!0,I&&I.classList.remove("active"),oe(),s("All highlights and clusters cleared","success")}function De(e){e&&(e.style.transform="scale(0.95)",setTimeout(()=>{e.style.transform="scale(1)"},150))}function re(e,t=1e3){e&&(e.style.animation=`aiPulse ${t}ms ease-in-out`,setTimeout(()=>{e.style.animation=""},t))}function le(){De(fe),re(document.querySelector(".ai-icon")),H()}document.addEventListener("mousemove",e=>{document.querySelectorAll(".particle").forEach((n,o)=>{const a=n.getBoundingClientRect(),i=Math.sqrt(Math.pow(e.clientX-(a.left+a.width/2),2)+Math.pow(e.clientY-(a.top+a.height/2),2));if(i<100){const c=1.5-i/100;n.style.transform=`scale(${c})`,n.style.opacity=Math.max(.3,1-i/150)}else n.style.transform="scale(1)",n.style.opacity=""})}),document.addEventListener("click",e=>{const t=document.createElement("div");t.style.cssText=`
            position: absolute;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(139, 92, 246, 0.4) 0%, transparent 70%);
            pointer-events: none;
            transform: translate(-50%, -50%);
            animation: rippleEffect 0.8s ease-out forwards;
            z-index: 2000;
            left: ${e.clientX}px;
            top: ${e.clientY}px;
            width: 0;
            height: 0;
        `,document.body.appendChild(t),setTimeout(()=>{document.body.contains(t)&&document.body.removeChild(t)},800)});function je(){setInterval(()=>{{const e=parseFloat(document.getElementById("similarity-accuracy").textContent),t=Math.max(94,Math.min(95,e+(Math.random()-.5)*.2));document.getElementById("similarity-accuracy").textContent=`${t.toFixed(1)}%`;const n=parseFloat(document.getElementById("search-speed").textContent),o=Math.max(.2,Math.min(.4,n+(Math.random()-.5)*.05));if(document.getElementById("search-speed").textContent=`${o.toFixed(2)}s`,Math.random()<.1){const a=["Background model optimization complete","Feature cache updated","Neural network weights synchronized","Processing pipeline optimized","Memory allocation rebalanced"],i=a[Math.floor(Math.random()*a.length)];s(i,"success")}}},3e3)}je();const ce=document.createElement("style");ce.textContent=`
        @keyframes rippleEffect {
            to {
                width: 200px;
                height: 200px;
                opacity: 0;
            }
        }

        .result-item {
            transition: all 0.3s ease;
        }

        .result-item:hover {
            transform: translateX(5px);
            background: rgba(15, 23, 42, 0.8) !important;
        }

        .feed-item {
            transition: all 0.3s ease;
        }

        .feed-item:hover {
            transform: translateX(3px);
            background: rgba(15, 23, 42, 0.6) !important;
        }

        .ai-feature-card {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .clustering-visualization {
            animation: modalSlideIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(50px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .legend-item {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .legend-item:hover {
            transform: translateX(5px);
            background: rgba(139, 92, 246, 0.1) !important;
        }
    `,document.head.appendChild(ce);function Ze(){let e=0,t=performance.now();function n(){e++;const o=performance.now();if(o-t>=2e3){const a=Math.round(e*1e3/(o-t));if(a<30){const i=document.querySelectorAll(".particle"),c=Math.floor(i.length*.3);for(let d=0;d<c;d++)i[d]&&i[d].parentNode&&i[d].parentNode.removeChild(i[d]);s(`Performance optimization: cached tiles (size: ${a})`,"warning")}e=0,t=o}requestAnimationFrame(n)}requestAnimationFrame(n)}Ze(),window.addEventListener("error",e=>{s(`System error: ${e.message}`,"error"),console.error("Stellar error:",e)}),window.addEventListener("unhandledrejection",e=>{s(`Promise rejection: ${e.reason}`,"error"),console.error("Stellar rejection:",e.reason)}),setTimeout(()=>{s("Stellar AI system fully operational","success"),s("Ready for planetary surface analysis","success");const e=document.querySelector(".ai-icon");e&&re(e,2e3)},1e3),setTimeout(()=>{var e,t;v(),console.log("Initialization complete - hiding loading overlays"),console.log("Loading overlay hidden:",(e=document.getElementById("loading-overlay"))==null?void 0:e.classList.contains("hidden")),console.log("Map loading hidden:",(t=document.getElementById("map-loading"))==null?void 0:t.classList.contains("hidden"))},1e3),setTimeout(()=>{const e=document.getElementById("loading-overlay"),t=document.getElementById("map-loading");e&&!e.classList.contains("hidden")&&(console.warn("Emergency: Force hiding loading overlay after timeout"),v()),t&&!t.classList.contains("hidden")&&(t.classList.add("hidden"),t.style.display="none")},8e3)});
